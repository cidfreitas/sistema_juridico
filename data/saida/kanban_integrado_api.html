<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öñÔ∏è Kanban - Sistema Jur√≠dico Ag√™ntico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            text-align: center;
        }

        .status-item h3 {
            color: #333;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .status-item .count {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .kanban-column.over {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.98);
        }

        .kanban-column h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .kanban-column.urgente h2 { border-color: #e74c3c; }
        .kanban-column.andamento h2 { border-color: #f39c12; }
        .kanban-column.espera h2 { border-color: #3498db; }
        .kanban-column.novo h2 { border-color: #27ae60; }

        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 500px;
            padding: 10px;
            border-radius: 8px;
        }

        .cards-container.over {
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed #667eea;
        }

        .card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .card:active {
            cursor: grabbing;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .card.dragging {
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .card.drag-over {
            border-top: 3px solid #667eea;
            margin-top: 10px;
        }

        .card.urgente { border-left: 4px solid #e74c3c; }
        .card.andamento { border-left: 4px solid #f39c12; }
        .card.espera { border-left: 4px solid #3498db; }
        .card.novo { border-left: 4px solid #27ae60; }

        .card-cnj {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-parte {
            font-size: 0.95em;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }

        .card-pasta {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-top: 40px;
        }

        @media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Kanban Jur√≠dico</h1>
            <p>Sincronizado em tempo real com SQLite</p>
        </div>

        <div id="error-container"></div>
        <div id="success-container"></div>

        <div class="status-bar">
            <div class="status-item">
                <h3>üî¥ Urgente</h3>
                <div class="count" id="count-urgente">0</div>
            </div>
            <div class="status-item">
                <h3>üü° Andamento</h3>
                <div class="count" id="count-andamento">0</div>
            </div>
            <div class="status-item">
                <h3>üîµ Espera</h3>
                <div class="count" id="count-espera">0</div>
            </div>
            <div class="status-item">
                <h3>üü¢ Novo</h3>
                <div class="count" id="count-novo">0</div>
            </div>
        </div>

        <div class="kanban-board" id="kanban-board">
            <div class="loading">Carregando processos...</div>
        </div>

        <div class="footer">
            <p>API: http://localhost:8000 | √öltima atualiza√ß√£o: <span id="last-update">-</span></p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        const API_KEY = 'sistema_juridico_cid_2025';

        let processos = [];
        let draggedCard = null;
        let dragSource = null;

        const headers = {
            'X-API-Key': API_KEY,
            'Content-Type': 'application/json'
        };

        // Carregar Processos
        async function carregarProcessos() {
            try {
                const response = await fetch(`${API_URL}/processos`, { headers });
                if (!response.ok) throw new Error('Erro ao carregar processos');
                
                const data = await response.json();
                processos = data.processos;
                renderizarKanban();
                atualizarTimestamp();
            } catch (error) {
                console.error('Erro:', error);
                mostrarErro('Erro ao conectar com API: ' + error.message);
            }
        }

        // Renderizar Kanban
        function renderizarKanban() {
            const statuses = ['urgente', 'andamento', 'espera', 'novo'];
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';

            const contadores = {
                urgente: 0,
                andamento: 0,
                espera: 0,
                novo: 0
            };

            statuses.forEach(status => {
                const column = document.createElement('div');
                column.className = `kanban-column ${status}`;
                column.dataset.status = status;

                const title = {
                    urgente: 'üî¥ URGENTE',
                    andamento: 'üü° EM ANDAMENTO',
                    espera: 'üîµ AGUARDANDO',
                    novo: 'üü¢ NOVO'
                };

                const container = document.createElement('div');
                container.className = 'cards-container';
                container.id = `container-${status}`;

                column.innerHTML = `<h2>${title[status]}</h2>`;
                column.appendChild(container);
                board.appendChild(column);

                processos.forEach(processo => {
                    if (processo.status === status) {
                        contadores[status]++;
                        const card = criarCard(processo);
                        container.appendChild(card);
                    }
                });

                // Setup drag listeners para container
                setupContainerListeners(container, status);
            });

            // Atualizar contadores
            Object.entries(contadores).forEach(([status, count]) => {
                document.getElementById(`count-${status}`).textContent = count;
            });
        }

        // Criar Card
        function criarCard(processo) {
            const card = document.createElement('div');
            card.className = `card ${processo.status}`;
            card.draggable = true;
            card.dataset.cnj = processo.cnj;
            card.dataset.status = processo.status;

            card.innerHTML = `
                <div class="card-cnj">${processo.cnj}</div>
                <div class="card-parte">${processo.parte.substring(0, 40)}</div>
                <div class="card-info">
                    <span>${processo.tribunal}</span>
                    <span class="card-pasta">${processo.pasta}</span>
                </div>
            `;

            // Event Listeners DRAG
            card.addEventListener('dragstart', (e) => {
                draggedCard = card;
                dragSource = card.parentElement; // Container de origem
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', processo.cnj);
            });

            card.addEventListener('dragend', (e) => {
                card.classList.remove('dragging');
                document.querySelectorAll('.card').forEach(c => {
                    c.classList.remove('drag-over');
                });
                document.querySelectorAll('.cards-container').forEach(c => {
                    c.classList.remove('over');
                });
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('over');
                });
                draggedCard = null;
                dragSource = null;
            });

            // Quando hover sobre outro card
            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedCard && draggedCard !== card) {
                    card.classList.add('drag-over');
                }
            });

            card.addEventListener('dragleave', (e) => {
                card.classList.remove('drag-over');
            });

            // Drop sobre outro card (reordena√ß√£o na mesma coluna)
            card.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedCard && draggedCard !== card) {
                    const container = card.parentElement;
                    const statusAtual = container.id.replace('container-', '');
                    
                    // Se est√£o no mesmo container, reordenar visualmente
                    if (draggedCard.parentElement === container) {
                        container.insertBefore(draggedCard, card);
                    }
                }
                
                card.classList.remove('drag-over');
            });

            return card;
        }

        // Setup Container Listeners
        function setupContainerListeners(container, status) {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                container.classList.add('over');
                container.parentElement.classList.add('over');
            });

            container.addEventListener('dragleave', (e) => {
                if (e.target === container) {
                    container.classList.remove('over');
                    container.parentElement.classList.remove('over');
                }
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                container.classList.remove('over');
                container.parentElement.classList.remove('over');

                if (draggedCard) {
                    const cnj = draggedCard.dataset.cnj;
                    const statusAnterior = draggedCard.dataset.status;
                    
                    // Adicionar card ao novo container
                    container.appendChild(draggedCard);
                    draggedCard.dataset.status = status;
                    
                    // Se mudou de coluna, atualizar na API
                    if (statusAnterior !== status) {
                        await atualizarStatus(cnj, status);
                    }
                }
            });
        }

        // Atualizar Status na API
        async function atualizarStatus(cnj, novoStatus) {
            try {
                console.log(`Atualizando ${cnj} para ${novoStatus}...`);
                
                const response = await fetch(`${API_URL}/processos/${cnj}/status`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ status: novoStatus })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                mostrarSucesso(`‚úÖ ${cnj} ‚Üí ${novoStatus}`);
                console.log('‚úÖ Atualizado com sucesso');
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                mostrarErro('Erro ao mover processo: ' + error.message);
                // Recarregar para reverter mudan√ßa
                carregarProcessos();
            }
        }

        // Mostrar Erro
        function mostrarErro(msg) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Mostrar Sucesso
        function mostrarSucesso(msg) {
            const container = document.getElementById('success-container');
            container.innerHTML = `<div class="success">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        // Atualizar Timestamp
        function atualizarTimestamp() {
            const now = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('last-update').textContent = now;
        }

        // Inicializar
        console.log('üöÄ Iniciando Kanban...');
        carregarProcessos();

        // Recarregar a cada 60 segundos
        setInterval(() => {
            console.log('üîÑ Sincronizando com servidor...');
            carregarProcessos();
        }, 60000);
    </script>
</body>
</html>
